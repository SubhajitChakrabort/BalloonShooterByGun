<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Balloon Shooter - Aim & Shoot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .balloon {
            transition: all 0.3s ease;
            animation: float 3s infinite alternate;
        }
        @keyframes float {
            from { transform: translateY(0px) rotate(5deg); }
            to { transform: translateY(-20px) rotate(-5deg); }
        }
        .game-background {
            background-image: url('back3.jpeg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            position: relative;
            overflow: hidden;
        }
        .gun {
            transition: transform 0.1s ease;
            transform-origin: center bottom;
            cursor: crosshair;
        }
        .heart-container {
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));
        }
        .loading-balloon {
            animation: loadingFloat 2s infinite ease-in-out;
        }
        @keyframes loadingFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
        }
        .score-text {
            color: #1e3a8a;
            text-shadow: 2px 2px 4px rgba(255,255,255,0.8);
        }
        .highest-score-text {
            color: #dc2626;
            text-shadow: 2px 2px 4px rgba(255,255,255,0.8);
        }
        
        /* Enhanced Crosshair */
        .crosshair {
            position: absolute;
            width: 30px;
            height: 30px;
            pointer-events: none;
            z-index: 100;
            transition: all 0.1s ease;
        }
        
        .crosshair-center {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #ff0000;
            border: 2px solid #ffffff;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.9), 0 0 30px rgba(255, 0, 0, 0.4);
        }
        
        /* Enhanced crosshair with cross lines */
        .crosshair::before,
        .crosshair::after {
            content: '';
            position: absolute;
            background: #ff0000;
            box-shadow: 0 0 8px rgba(255, 0, 0, 0.7);
        }
        
        .crosshair::before {
            width: 2px;
            height: 30px;
            left: 50%;
            top: 0;
            transform: translateX(-50%);
        }
        
        .crosshair::after {
            width: 30px;
            height: 2px;
            top: 50%;
            left: 0;
            transform: translateY(-50%);
        }
        
        /* Light Laser Sight */
        .laser-sight {
            position: absolute;
            height: 1px;
            background: linear-gradient(to right, 
                rgba(255, 0, 0, 0.3) 0%,
                rgba(255, 0, 0, 0.2) 20%,
                rgba(255, 0, 0, 0.15) 40%,
                rgba(255, 0, 0, 0.1) 60%,
                rgba(255, 0, 0, 0.05) 80%,
                transparent 100%);
            transform-origin: left center;
            z-index: 85;
            pointer-events: none;
            box-shadow: 0 0 3px rgba(255, 0, 0, 0.2);
        }
        
        /* Gun container - rotatable */
        .gun-container {
            transition: all 0.1s ease;
            transform-origin: center bottom;
            cursor: crosshair;
        }
        
        .gun-container:hover {
            transform: translateX(-50%) scale(1.05);
        }
        
        .gun-container:active {
            transform: translateX(-50%) scale(0.95);
        }
        
        /* Muzzle flash effect */
        .muzzle-flash {
            position: absolute;
            width: 35px;
            height: 35px;
            background: radial-gradient(circle, #ffff00, #ff8800, #ff4400, transparent);
            border-radius: 50%;
            opacity: 0;
            z-index: 50;
            animation: flash 0.15s ease-out;
        }
        
        @keyframes flash {
            0% { opacity: 0; transform: scale(0); }
            50% { opacity: 1; transform: scale(2); }
            100% { opacity: 0; transform: scale(3); }
        }
        
        /* Bullet trail effect */
        .bullet-trail {
            position: absolute;
            width: 5px;
            height: 35px;
            background: linear-gradient(to top, #ffff00, #ff8800, transparent);
            border-radius: 50%;
            z-index: 40;
            animation: bulletFly 0.3s linear;
            box-shadow: 0 0 12px rgba(255, 255, 0, 0.7);
        }
        
        @keyframes bulletFly {
            0% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(0.3); }
        }
        
        /* Hit marker - Enhanced */
        .hit-marker {
            position: absolute;
            width: 40px;
            height: 40px;
            pointer-events: none;
            z-index: 150;
            animation: hitMarkerShow 0.5s ease-out;
        }
        
        .hit-marker::before,
        .hit-marker::after {
            content: '';
            position: absolute;
            background: #00ff00;
            box-shadow: 0 0 12px rgba(0, 255, 0, 0.8);
        }
        
        .hit-marker::before {
            width: 3px;
            height: 40px;
            left: 50%;
            top: 0;
            transform: translateX(-50%);
        }
        
        .hit-marker::after {
            width: 40px;
            height: 3px;
            top: 50%;
            left: 0;
            transform: translateY(-50%);
        }
        
        @keyframes hitMarkerShow {
            0% { opacity: 0; transform: scale(0.5); }
            50% { opacity: 1; transform: scale(1.2); }
            100% { opacity: 0; transform: scale(1); }
        }
        
        /* Points popup animation */
        .points-popup {
            position: absolute;
            font-weight: bold;
            font-size: 2rem;
            color: #00ff00;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            pointer-events: none;
            z-index: 1000;
            animation: pointsFloat 2s ease-out forwards;
        }
        
        @keyframes pointsFloat {
            0% {
                opacity: 1;
                transform: translateY(0px) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateY(-80px) scale(1.5);
            }
        }
        
        /* Balloon vanish animation */
        .balloon-vanish {
            animation: vanishAtTop 0.5s ease-out forwards;
        }
        
        @keyframes vanishAtTop {
            0% {
                opacity: 1;
                transform: scale(1);
            }
            100% {
                opacity: 0;
                transform: scale(0.5);
            }
        }
        
        /* NEW FEATURE: Power-up Effects */
        .power-up {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            animation: powerUpFloat 4s infinite ease-in-out;
            z-index: 25;
            cursor: pointer;
            box-shadow: 0 0 20px rgba(255, 255, 0, 0.8);
        }
        
        @keyframes powerUpFloat {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-30px) rotate(180deg); }
        }
        
        .power-up-multi {
            background: radial-gradient(circle, #ff6b35, #f7931e);
            border: 3px solid #fff;
        }
        
        .power-up-rapid {
            background: radial-gradient(circle, #4ecdc4, #44a08d);
            border: 3px solid #fff;
        }
        
        .power-up-big {
            background: radial-gradient(circle, #a8e6cf, #7fcdcd);
            border: 3px solid #fff;
        }
        
        /* NEW FEATURE: Combo System */
        .combo-display {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem;
            font-weight: bold;
            color: #ff6b35;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.8);
            z-index: 200;
            animation: comboShow 1.5s ease-out forwards;
            pointer-events: none;
        }
        
        @keyframes comboShow {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1); }
        }
        
        /* NEW FEATURE: Moving Balloons */
        .balloon-zigzag {
            animation: zigzagMove 6s infinite linear;
        }
        
        @keyframes zigzagMove {
            0% { transform: translateX(0px); }
            25% { transform: translateX(50px); }
            50% { transform: translateX(0px); }
            75% { transform: translateX(-50px); }
            100% { transform: translateX(0px); }
        }
        
        /* NEW FEATURE: Special Balloons */
        .balloon-golden {
            filter: hue-rotate(45deg) brightness(1.5) saturate(2);
            animation: goldenGlow 2s infinite ease-in-out;
        }
        
        @keyframes goldenGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.8); }
            50% { box-shadow: 0 0 40px rgba(255, 215, 0, 1); }
        }
        
        .balloon-bomb {
            filter: hue-rotate(180deg) brightness(0.8);
            animation: bombPulse 1s infinite ease-in-out;
        }
        
        @keyframes bombPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        /* NEW FEATURE: Streak Display */
        .streak-display {
            position: fixed;
            top: 120px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            color: #ff6b35;
            padding: 10px 15px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 1.2rem;
            z-index: 100;
            border: 2px solid #ff6b35;
            animation: streakPulse 2s infinite ease-in-out;
        }
        
        @keyframes streakPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        /* Balloon uniform size - larger for all devices */
        .balloon-uniform {
            width: 80px !important;
            height: 120px !important;
        }
        
        /* Specific balloon sizes for b2, b3, b4 - larger */
        .balloon-b2, .balloon-b3, .balloon-b4 {
            width: 90px !important;
            height: 135px !important;
        }
        
        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .score-container {
                flex-direction: row;
                justify-content: space-between;
                align-items: flex-start;
                width: 100%;
            }
            .score-left {
                text-align: left;
            }
            .score-right {
                text-align: right;
            }
            .game-title {
                font-size: 2rem;
            }
            .score-text {
                font-size: 1.5rem;
            }
            .highest-score-text {
                font-size: 1.5rem;
            }
            .game-area-mobile {
                height: 70vh;
            }
            .gun-mobile {
                width: 18vw;
                height: 18vw;
                max-width: 80px;
                max-height: 80px;
            }
            .balloon-uniform {
                width: 60px !important;
                height: 90px !important;
            }
            .balloon-b2, .balloon-b3, .balloon-b4 {
                width: 70px !important;
                height: 105px !important;
            }
            .heart-mobile {
                width: 8vw;
                height: 8vw;
                max-width: 32px;
                max-height: 32px;
            }
            .points-popup {
                font-size: 1.5rem;
            }
            .play-again-btn {
                font-size: 1.2rem;
                padding: 12px 24px;
                touch-action: manipulation;
                -webkit-tap-highlight-color: transparent;
            }
            .crosshair {
                width: 25px;
                height: 25px;
            }
            .crosshair-center {
                width: 10px;
                height: 10px;
            }
            .crosshair::before {
                height: 25px;
            }
            .crosshair::after {
                width: 25px;
            }
            .streak-display {
                top: 80px;
                right: 10px;
                font-size: 1rem;
                padding: 8px 12px;
            }
                        .combo-display {
                font-size: 2rem;
            }
            .power-up {
                width: 35px;
                height: 35px;
            }
        }
        
        @media (max-width: 480px) {
            .game-title {
                font-size: 1.75rem;
            }
            .score-text {
                font-size: 1.25rem;
            }
            .highest-score-text {
                font-size: 1.25rem;
            }
            .loading-balloon-mobile {
                width: 32vw;
                height: 32vw;
                max-width: 150px;
                max-height: 150px;
            }
            .points-popup {
                font-size: 1.2rem;
            }
            .balloon-uniform {
                width: 50px !important;
                height: 75px !important;
            }
            .balloon-b2, .balloon-b3, .balloon-b4 {
                width: 60px !important;
                height: 90px !important;
            }
            .play-again-btn {
                font-size: 1.1rem;
                padding: 10px 20px;
            }
            .crosshair {
                width: 22px;
                height: 22px;
            }
            .crosshair-center {
                width: 8px;
                height: 8px;
            }
            .crosshair::before {
                height: 22px;
            }
            .crosshair::after {
                width: 22px;
            }
            .streak-display {
                font-size: 0.9rem;
                padding: 6px 10px;
            }
            .combo-display {
                font-size: 1.5rem;
            }
            .power-up {
                width: 30px;
                height: 30px;
            }
        }
        
        /* Instructions panel */
        .instructions {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-size: 14px;
            z-index: 150;
            max-width: 280px;
            border: 2px solid #00ff00;
        }
        
        @media (max-width: 768px) {
            .instructions {
                top: 10px;
                left: 10px;
                padding: 10px;
                font-size: 12px;
                max-width: 220px;
            }
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-gradient-to-b from-blue-400 to-blue-600 z-50 flex flex-col items-center justify-center px-4">
        <!-- Balloon Image -->
        <img src="ballon.jpeg" class="w-48 h-48 md:w-48 md:h-48 loading-balloon-mobile loading-balloon mb-8 rounded-full shadow-2xl" alt="Balloon">
        
        <!-- Game Title -->
        <h1 class="text-4xl md:text-4xl game-title font-bold text-white mb-8 text-center">Balloon Shooter</h1>
        
        <!-- Progress Bar Container -->
        <div class="w-80 max-w-sm h-6 bg-white/30 rounded-full mt-4 backdrop-blur-sm border-2 border-white/50">
            <div id="progressBar" class="h-full bg-gradient-to-r from-amber-400 to-rose-600 rounded-full transition-all duration-300 shadow-lg" style="width: 0%"></div>
        </div>
        
        <!-- Progress Text -->
        <p id="progressText" class="text-white mt-6 text-xl font-semibold">Loading... 0%</p>
        
        <!-- Loading Dots Animation -->
        <div class="flex space-x-2 mt-4">
            <div class="w-3 h-3 bg-white rounded-full animate-bounce"></div>
            <div class="w-3 h-3 bg-white rounded-full animate-bounce" style="animation-delay: 0.1s;"></div>
            <div class="w-3 h-3 bg-white rounded-full animate-bounce" style="animation-delay: 0.2s;"></div>
        </div>
    </div>

    <!-- Game Over Screen -->
    <div id="gameOverScreen" class="hidden fixed inset-0 bg-black/80 z-50 flex flex-col items-center justify-center px-4">
        <h2 class="text-4xl md:text-6xl font-bold text-red-500 mb-8 text-center">Game Over</h2>
        <p class="text-2xl md:text-3xl text-white mb-4 text-center">Final Score: <span id="finalScore" class="text-blue-400 font-bold">0</span></p>
        <p class="text-xl md:text-2xl text-white mb-4 text-center">Highest Score: <span id="gameOverHighestScore" class="text-yellow-400 font-bold">0</span></p>
        <p class="text-lg md:text-xl text-white mb-8 text-center">Best Streak: <span id="gameOverBestStreak" class="text-green-400 font-bold">0</span></p>
        <button id="playAgainBtn" class="bg-green-500 hover:bg-green-600 active:bg-green-700 text-white font-bold py-3 px-6 rounded-lg text-xl transition-colors play-again-btn">
            Play Again
        </button>
    </div>

    <!-- Game Screen -->
    <div id="gameScreen" class="hidden">
        <div class="game-background min-h-screen">
            <!-- Instructions Panel -->
            <div class="instructions">
                <div class="font-bold mb-2">ðŸŽ¯ How to Play:</div>
                <div>â€¢ Move mouse/finger to aim</div>
                <div>â€¢ Click GUN to shoot</div>
                <div>â€¢ Hit balloons to score points</div>
                <div>â€¢ ðŸŸ¡ Golden balloons = 20 points</div>
                <div>â€¢ ðŸ’£ Bomb balloons = -10 points</div>
                <div>â€¢ Collect power-ups for bonuses!</div>
                <div>â€¢ Build streaks for multipliers!</div>
            </div>
            
            <!-- Streak Display -->
            <div id="streakDisplay" class="streak-display hidden">
                Streak: <span id="streakCount">0</span>x
            </div>
            
            <!-- Game Container -->
            <div class="container mx-auto px-2 md:px-4 py-4 md:py-8 relative">
                <!-- Score and Lives -->
                <div class="flex justify-between items-start mb-4 md:mb-8 score-container w-full">
                    <div class="score-left">
                        <div class="text-2xl md:text-3xl font-bold score-text">Score: <span id="score">0</span></div>
                        <div class="text-lg md:text-xl font-bold text-purple-600">Multiplier: <span id="multiplier">1</span>x</div>
                    </div>
                    <div class="score-right flex flex-col items-end">
                        <div class="text-2xl md:text-3xl font-bold highest-score-text mb-2">Highest: <span id="highestScore">0</span></div>
                        <div id="lives" class="heart-container flex gap-1 md:gap-2">
                            <img src="https://www.freeiconspng.com/uploads/heart-icon-14.png" class="w-8 h-8 md:w-10 md:h-10 heart-mobile">
                            <img src="https://www.freeiconspng.com/uploads/heart-icon-14.png" class="w-8 h-8 md:w-10 md:h-10 heart-mobile">
                            <img src="https://www.freeiconspng.com/uploads/heart-icon-14.png" class="w-8 h-8 md:w-10 md:h-10 heart-mobile">
                        </div>
                    </div>
                </div>
                
                <!-- Game Area -->
                <div id="gameArea" class="relative h-[70vh] md:h-[80vh] game-area-mobile overflow-hidden rounded-3xl">
                    <!-- Enhanced Crosshair -->
                    <div id="crosshair" class="crosshair">
                        <div class="crosshair-center"></div>
                    </div>
                    
                    <!-- Light Laser Sight -->
                    <div id="laserSight" class="laser-sight"></div>
                    
                    <!-- Gun Container - Rotatable -->
                    <div id="gunContainer" class="absolute bottom-2 md:bottom-4 left-1/2 transform -translate-x-1/2 z-10 gun-container">
                        <img id="gun" src="gun.png" 
                             class="w-20 h-20 md:w-28 md:h-28 gun-mobile gun" alt="Gun" title="Click to Shoot!">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let score = 0;
        let lives = 3;
        let missedBalloons = 0;
        let highestScore = 0;
        let balloonIntervals = [];
        let gunAngle = 90;
        let targetAngle = 90;
        
        // NEW FEATURES: Game state variables
        let streak = 0;
        let bestStreak = 0;
        let multiplier = 1;
        let powerUpActive = false;
        let powerUpType = '';
        let powerUpDuration = 0;
        let rapidFireMode = false;
        let multiShotMode = false;
        let bigBulletsMode = false;
        
        // All preset angles
        const presetAngles = [30, 45, 60, 75, 90, 105, 120, 135, 150, 165, 180];
        
        // Enhanced balloon configuration with special types
        const balloonTypes = [
            { image: 'b1.png', points: 2, class: 'balloon-uniform', type: 'normal' },
            { image: 'b2.png', points: 3, class: 'balloon-b2', type: 'normal' },
            { image: 'b3.png', points: 5, class: 'balloon-b3', type: 'normal' },
            { image: 'b4.png', points: 5, class: 'balloon-b4', type: 'normal' },
            { image: 'b5.png', points: 10, class: 'balloon-uniform', type: 'normal' },
            { image: 'b6.png', points: 7, class: 'balloon-uniform', type: 'normal' }
        ];
        
        // Power-up types
        const powerUpTypes = [
            { type: 'multi', class: 'power-up-multi', duration: 10000, name: 'Multi Shot' },
            { type: 'rapid', class: 'power-up-rapid', duration: 8000, name: 'Rapid Fire' },
            { type: 'big', class: 'power-up-big', duration: 12000, name: 'Big Bullets' }
        ];
        
        const shootSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2771/2771-preview.mp3');
        const popSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2870/2870-preview.mp3');
        const gameOverSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2658/2658-preview.mp3');
        const hitSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3');
        const powerUpSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2018/2018-preview.mp3');
        const comboSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3');

        // Game initialization
        window.onload = () => {
            loadHighestScore();
            loadBestStreak();
            loadGame();
            preloadSounds();
            setupPlayAgainButton();
        };

        function setupPlayAgainButton() {
            const playAgainBtn = document.getElementById('playAgainBtn');
            
            playAgainBtn.removeEventListener('click', restartGame);
            playAgainBtn.removeEventListener('touchend', handlePlayAgainTouch);
            
            playAgainBtn.addEventListener('click', restartGame);
            playAgainBtn.addEventListener('touchend', handlePlayAgainTouch);
        }

        function handlePlayAgainTouch(e) {
            e.preventDefault();
            e.stopPropagation();
            restartGame();
        }

        function loadHighestScore() {
            const saved = localStorage.getItem('balloonCrackerHighestScore');
            if (saved) {
                highestScore = parseInt(saved);
                updateHighestScore();
            }
        }

        function loadBestStreak() {
            const saved = localStorage.getItem('balloonCrackerBestStreak');
            if (saved) {
                bestStreak = parseInt(saved);
                updateBestStreak();
            }
        }

        function saveHighestScore() {
            localStorage.setItem('balloonCrackerHighestScore', highestScore.toString());
        }

        function saveBestStreak() {
            localStorage.setItem('balloonCrackerBestStreak', bestStreak.toString());
        }

        function updateHighestScore() {
            document.getElementById('highestScore').textContent = highestScore;
            document.getElementById('gameOverHighestScore').textContent = highestScore;
        }

        function updateBestStreak() {
            document.getElementById('gameOverBestStreak').textContent = bestStreak;
        }

        function preloadSounds() {
            shootSound.load();
            popSound.load();
            gameOverSound.load();
            hitSound.load();
            powerUpSound.load();
            comboSound.load();
        }

        function loadGame() {
            let progress = 0;
            const interval = setInterval(() => {
                progress += 2;
                document.getElementById('progressBar').style.width = `${progress}%`;
                document.getElementById('progressText').textContent = `Loading... ${progress}%`;
                
                if (progress >= 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        document.getElementById('loadingScreen').classList.add('hidden');
                        document.getElementById('gameScreen').classList.remove('hidden');
                        startGame();
                    }, 500);
                }
            }, 50);
        }

        function startGame() {
            // Reset all game variables
            score = 0;
            lives = 3;
            missedBalloons = 0;
            streak = 0;
                       multiplier = 1;
            powerUpActive = false;
            powerUpType = '';
            powerUpDuration = 0;
            rapidFireMode = false;
            multiShotMode = false;
            bigBulletsMode = false;
            gunAngle = 90;
            targetAngle = 90;
            
            // Clear intervals and balloons
            balloonIntervals.forEach(interval => clearInterval(interval));
            balloonIntervals = [];
            
            const existingBalloons = document.querySelectorAll('.balloon');
            existingBalloons.forEach(balloon => balloon.remove());
            
            const existingPowerUps = document.querySelectorAll('.power-up');
            existingPowerUps.forEach(powerUp => powerUp.remove());
            
            updateScore();
            updateLives();
            updateHighestScore();
            updateBestStreak();
            updateStreak();
            updateMultiplier();
            setupControls();
            updateGunRotation();
            createBalloons();
            createPowerUps();
        }

        function createBalloons() {
            const settings = getOptimalSettings();
            
            const interval = setInterval(() => {
                const currentBalloons = document.querySelectorAll('.balloon').length;
                if (currentBalloons < settings.maxBalloons && Math.random() < 0.7) {
                    createBalloon();
                }
            }, settings.balloonInterval);
            
            balloonIntervals.push(interval);
        }

        function createPowerUps() {
            const interval = setInterval(() => {
                const currentPowerUps = document.querySelectorAll('.power-up').length;
                if (currentPowerUps < 2 && Math.random() < 0.3) {
                    createPowerUp();
                }
            }, 15000); // Power-up every 15 seconds
            
            balloonIntervals.push(interval);
        }

        function createBalloon() {
            const settings = getOptimalSettings();
            let balloonType = balloonTypes[Math.floor(Math.random() * balloonTypes.length)];
            
            // 10% chance for special balloons
            const specialChance = Math.random();
            let isSpecial = false;
            let specialType = 'normal';
            
            if (specialChance < 0.05) { // 5% golden balloon
                specialType = 'golden';
                balloonType = { ...balloonType, points: 20, type: 'golden' };
                isSpecial = true;
            } else if (specialChance < 0.08) { // 3% bomb balloon
                specialType = 'bomb';
                balloonType = { ...balloonType, points: -10, type: 'bomb' };
                isSpecial = true;
            }
            
            const balloon = document.createElement('img');
            balloon.src = balloonType.image;
            balloon.className = `balloon absolute ${balloonType.class}`;
            balloon.style.left = `${Math.random() * 70 + 10}%`;
            balloon.style.bottom = '-150px';
            balloon.style.zIndex = '20';
            
            balloon.dataset.points = balloonType.points;
            balloon.dataset.type = balloonType.type;
            
            // Add special balloon effects
            if (specialType === 'golden') {
                balloon.classList.add('balloon-golden');
            } else if (specialType === 'bomb') {
                balloon.classList.add('balloon-bomb');
            }
            
            // 30% chance for moving balloons
            if (Math.random() < 0.3) {
                balloon.classList.add('balloon-zigzag');
            }
            
            balloon.onerror = function() {
                this.style.backgroundColor = isSpecial ? 
                    (specialType === 'golden' ? '#ffd700' : '#ff4444') : '#ff6b6b';
                this.style.borderRadius = '50% 50% 50% 50% / 60% 60% 40% 40%';
                this.style.border = '2px solid #ff5252';
                this.style.width = '60px';
                this.style.height = '90px';
            };
            
            document.getElementById('gameArea').appendChild(balloon);
            
            const animation = balloon.animate([
                { 
                    bottom: '-150px', 
                    opacity: 1,
                    transform: 'translateY(0px) rotate(0deg)'
                },
                { 
                    bottom: '50%', 
                    opacity: 1,
                    transform: 'translateY(-10px) rotate(5deg)'
                },
                { 
                    bottom: 'calc(100% + 50px)', 
                    opacity: 0.8,
                    transform: 'translateY(-20px) rotate(-5deg)'
                }
            ], {
                duration: settings.balloonSpeed,
                easing: 'linear'
            });

            let animationFrame;
            const checkBalloonPosition = () => {
                if (balloon.parentNode) {
                    const balloonRect = balloon.getBoundingClientRect();
                    const gameAreaRect = document.getElementById('gameArea').getBoundingClientRect();
                    
                    if (balloonRect.bottom <= gameAreaRect.top) {
                        balloon.classList.add('balloon-vanish');
                        
                        setTimeout(() => {
                            if (balloon.parentNode) {
                                balloon.remove();
                                missedBalloons++;
                                if (missedBalloons >= 5) {
                                    loseLife();
                                    missedBalloons = 0;
                                }
                                // Reset streak on missed balloon
                                if (balloon.dataset.type !== 'bomb') {
                                    resetStreak();
                                }
                            }
                        }, 500);
                        
                        cancelAnimationFrame(animationFrame);
                    } else {
                        animationFrame = requestAnimationFrame(checkBalloonPosition);
                    }
                }
            };
            
            animationFrame = requestAnimationFrame(checkBalloonPosition);

            animation.onfinish = () => {
                if (balloon.parentNode) {
                    balloon.remove();
                    missedBalloons++;
                    if (missedBalloons >= 5) {
                        loseLife();
                        missedBalloons = 0;
                    }
                    // Reset streak on missed balloon
                    if (balloon.dataset.type !== 'bomb') {
                        resetStreak();
                    }
                }
                cancelAnimationFrame(animationFrame);
            };
        }

        function createPowerUp() {
            const powerUpType = powerUpTypes[Math.floor(Math.random() * powerUpTypes.length)];
            
            const powerUp = document.createElement('div');
            powerUp.className = `power-up ${powerUpType.class}`;
            powerUp.style.left = `${Math.random() * 80 + 10}%`;
            powerUp.style.bottom = '-50px';
            powerUp.dataset.type = powerUpType.type;
            powerUp.dataset.duration = powerUpType.duration;
            powerUp.dataset.name = powerUpType.name;
            
            // Add power-up icon
            const icon = document.createElement('div');
            icon.style.cssText = `
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 20px;
                font-weight: bold;
                color: white;
                text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            `;
            
            switch(powerUpType.type) {
                case 'multi':
                    icon.textContent = '3x';
                    break;
                case 'rapid':
                    icon.textContent = 'âš¡';
                    break;
                case 'big':
                    icon.textContent = 'ðŸ’¥';
                    break;
            }
            
            powerUp.appendChild(icon);
            
            // Add click handler
            powerUp.addEventListener('click', () => collectPowerUp(powerUp));
            powerUp.addEventListener('touchend', (e) => {
                e.preventDefault();
                collectPowerUp(powerUp);
            });
            
            document.getElementById('gameArea').appendChild(powerUp);
            
            // Animate power-up movement
            const animation = powerUp.animate([
                { bottom: '-50px', opacity: 1 },
                { bottom: 'calc(100% + 50px)', opacity: 0.8 }
            ], {
                duration: 12000,
                easing: 'linear'
            });

            animation.onfinish = () => {
                if (powerUp.parentNode) {
                    powerUp.remove();
                }
            };
        }

        function collectPowerUp(powerUp) {
            const type = powerUp.dataset.type;
            const duration = parseInt(powerUp.dataset.duration);
            const name = powerUp.dataset.name;
            
            // Play power-up sound
            powerUpSound.currentTime = 0;
            powerUpSound.play().catch(() => {});
            
            // Activate power-up
            activatePowerUp(type, duration, name);
            
            // Remove power-up with effect
            powerUp.style.transform = 'scale(2)';
            powerUp.style.opacity = '0';
            
            setTimeout(() => {
                if (powerUp.parentNode) {
                    powerUp.remove();
                }
            }, 300);
            
            // Show power-up notification
            showPowerUpNotification(name, duration);
        }

        function activatePowerUp(type, duration, name) {
            powerUpActive = true;
            powerUpType = type;
            powerUpDuration = duration;
            
            switch(type) {
                case 'multi':
                    multiShotMode = true;
                    break;
                case 'rapid':
                    rapidFireMode = true;
                    break;
                case 'big':
                    bigBulletsMode = true;
                    break;
            }
            
            // Set timeout to deactivate power-up
            setTimeout(() => {
                deactivatePowerUp();
            }, duration);
        }

        function deactivatePowerUp() {
            powerUpActive = false;
            multiShotMode = false;
            rapidFireMode = false;
            bigBulletsMode = false;
            powerUpType = '';
            powerUpDuration = 0;
        }

        function showPowerUpNotification(name, duration) {
            const notification = document.createElement('div');
            notification.className = 'combo-display';
            notification.textContent = `${name} Activated!`;
            notification.style.color = '#4ecdc4';
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 1500);
        }

        function setupControls() {
            // Remove existing event listeners
            document.removeEventListener('mousemove', handleMouseMove);
            document.removeEventListener('touchmove', handleTouchMove);
            document.removeEventListener('keydown', handleKeyDown);
            
            // Add event listeners for gun rotation
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('touchmove', handleTouchMove);
            document.addEventListener('keydown', handleKeyDown);

            // Gun click/touch to shoot
            const gunContainer = document.getElementById('gunContainer');
            const gun = document.getElementById('gun');
            
            // Remove existing listeners
            gunContainer.removeEventListener('click', shoot);
            gunContainer.removeEventListener('touchend', handleGunTouch);
            gun.removeEventListener('click', shoot);
            gun.removeEventListener('touchend', handleGunTouch);
            
            // Add shoot listeners to both gun container and gun image
            gunContainer.addEventListener('click', shoot);
            gunContainer.addEventListener('touchend', handleGunTouch);
            gun.addEventListener('click', shoot);
            gun.addEventListener('touchend', handleGunTouch);
        }

        function handleKeyDown(e) {
            if (e.key === ' ') {
                e.preventDefault();
                shoot();
            }
            // Arrow keys to cycle through preset angles
            if (e.key === 'ArrowLeft') {
                const currentIndex = presetAngles.indexOf(targetAngle);
                const nextIndex = Math.min(currentIndex + 1, presetAngles.length - 1);
                targetAngle = presetAngles[nextIndex];
                snapToAngle();
            }
            if (e.key === 'ArrowRight') {
                const currentIndex = presetAngles.indexOf(targetAngle);
                const nextIndex = Math.max(currentIndex - 1, 0);
                targetAngle = presetAngles[nextIndex];
                snapToAngle();
            }
        }

        function handleMouseMove(e) {
            const gameArea = document.getElementById('gameArea');
            const rect = gameArea.getBoundingClientRect();
            
            // Calculate mouse position relative to gun position
            const gunX = rect.left + rect.width / 2;
            const gunY = rect.bottom - 50;
            
            const mouseX = e.clientX;
            const mouseY = e.clientY;
            
            // Calculate angle from gun to mouse
            const deltaX = mouseX - gunX;
            const deltaY = gunY - mouseY;
            
            let angle = Math.atan2(deltaX, deltaY) * (180 / Math.PI);
            let gunAngleCalculated = 90 - angle;
            
            if (gunAngleCalculated < 0) gunAngleCalculated += 360;
            if (gunAngleCalculated > 360) gunAngleCalculated -= 360;
            
            if (gunAngleCalculated > 180) {
                gunAngleCalculated = 360 - gunAngleCalculated;
            }
            
            gunAngleCalculated = Math.max(30, Math.min(180, gunAngleCalculated));
            
            targetAngle = findClosestAngle(gunAngleCalculated);
            snapToAngle();
        }

        function handleTouchMove(e) {
            e.preventDefault();
            const gameArea = document.getElementById('gameArea');
            const rect = gameArea.getBoundingClientRect();
            const touch = e.touches[0];
            
            const gunX = rect.left + rect.width / 2;
            const gunY = rect.bottom - 50;
            
            const touchX = touch.clientX;
            const touchY = touch.clientY;
            
            const deltaX = touchX - gunX;
            const deltaY = gunY - touchY;
            
            let angle = Math.atan2(deltaX, deltaY) * (180 / Math.PI);
            let gunAngleCalculated = 90 - angle;
            
            if (gunAngleCalculated < 0) gunAngleCalculated += 360;
            if (gunAngleCalculated > 360) gunAngleCalculated -= 360;
            
            if (gunAngleCalculated > 180) {
                gunAngleCalculated = 360 - gunAngleCalculated;
            }
            
            gunAngleCalculated = Math.max(30, Math.min(180, gunAngleCalculated));
            
            targetAngle = findClosestAngle(gunAngleCalculated);
            snapToAngle();
        }

        function handleGunTouch(e) {
            e.preventDefault();
            e.stopPropagation();
            shoot();
        }

        function findClosestAngle(inputAngle) {
                       inputAngle = Math.max(30, Math.min(180, inputAngle));
            
            let closestAngle = presetAngles[0];
            let minDifference = Math.abs(inputAngle - presetAngles[0]);
            
            for (let i = 1; i < presetAngles.length; i++) {
                const difference = Math.abs(inputAngle - presetAngles[i]);
                if (difference < minDifference) {
                    minDifference = difference;
                    closestAngle = presetAngles[i];
                }
            }
            
            return closestAngle;
        }

        function snapToAngle() {
            gunAngle = targetAngle;
            updateGunRotation();
        }

        function updateGunRotation() {
            const gunContainer = document.getElementById('gunContainer');
            const crosshair = document.getElementById('crosshair');
            const laserSight = document.getElementById('laserSight');
            
            const rotationAngle = gunAngle - 90;
            
            gunContainer.style.transform = `translateX(-50%) rotate(${rotationAngle}deg)`;
            
            if (gunAngle === 30 || gunAngle === 180) {
                crosshair.style.opacity = '0';
                laserSight.style.opacity = '0';
            } else {
                crosshair.style.opacity = '1';
                laserSight.style.opacity = '0.4';
                
                const gameArea = document.getElementById('gameArea');
                const gunX = 50;
                const gunY = 95;
                
                const angleRad = (gunAngle - 90) * (Math.PI / 180);
                const aimDistance = 35;
                const aimX = gunX + (Math.sin(angleRad) * aimDistance);
                const aimY = gunY - (Math.cos(angleRad) * aimDistance);
                
                const clampedAimX = Math.max(8, Math.min(92, aimX));
                const clampedAimY = Math.max(8, Math.min(92, aimY));
                
                crosshair.style.left = `${clampedAimX}%`;
                crosshair.style.top = `${clampedAimY}%`;
                crosshair.style.transform = 'translate(-50%, -50%)';
                
                updateLaserSight();
            }
        }

        function updateLaserSight() {
            const laserSight = document.getElementById('laserSight');
            const gameArea = document.getElementById('gameArea');
            const rect = gameArea.getBoundingClientRect();
            
            const gunX = rect.width * 0.5;
            const gunY = rect.height * 0.95;
            
            const angleRad = (gunAngle - 90) * (Math.PI / 180);
            const barrelLength = 35;
            
            const barrelX = gunX + Math.sin(angleRad) * barrelLength;
            const barrelY = gunY - Math.cos(angleRad) * barrelLength;
            
            const laserLength = 400;
            laserSight.style.left = `${barrelX}px`;
            laserSight.style.top = `${barrelY}px`;
            laserSight.style.width = `${laserLength}px`;
            laserSight.style.transform = `rotate(${gunAngle - 90}deg)`;
            laserSight.style.transformOrigin = 'left center';
        }

        function shoot() {
            const gun = document.getElementById('gun');
            
            // Play shoot sound
            shootSound.currentTime = 0;
            shootSound.play().catch(() => {});
            
            // Gun recoil animation
            gun.style.transform = 'translateY(-15px) scale(1.2)';
            setTimeout(() => gun.style.transform = 'none', 200);

            // Create effects
            createMuzzleFlash();
            
            // Multi-shot mode
            if (multiShotMode) {
                createBulletTrail();
                setTimeout(() => createBulletTrail(), 100);
                setTimeout(() => createBulletTrail(), 200);
            } else {
                createBulletTrail();
            }
            
            // Check for hits
            const hit = checkHits();
            
            if (!hit) {
                showMissIndicator();
                resetStreak();
            }
            
            // Vibration feedback
            vibrate(50);
        }

        function createMuzzleFlash() {
            const gunContainer = document.getElementById('gunContainer');
            const flash = document.createElement('div');
            flash.className = 'muzzle-flash';
            
            const angleRad = (gunAngle - 90) * (Math.PI / 180);
            const barrelDistance = 35;
            
            const flashX = Math.sin(angleRad) * barrelDistance;
            const flashY = -Math.cos(angleRad) * barrelDistance;
            
            flash.style.left = `calc(50% + ${flashX}px)`;
            flash.style.top = `calc(50% + ${flashY}px)`;
            flash.style.transform = 'translate(-50%, -50%)';
            
            gunContainer.appendChild(flash);
            
            setTimeout(() => {
                if (flash.parentNode) {
                    flash.remove();
                }
            }, 150);
        }

        function createBulletTrail() {
            const gameArea = document.getElementById('gameArea');
            const trail = document.createElement('div');
            trail.className = 'bullet-trail';
            
            // Enhanced bullet for big bullets mode
            if (bigBulletsMode) {
                trail.style.width = '10px';
                trail.style.height = '50px';
                trail.style.boxShadow = '0 0 20px rgba(255, 255, 0, 1)';
            }
            
            const rect = gameArea.getBoundingClientRect();
            const gunX = 50;
            const gunY = 95;
            
            const angleRad = (gunAngle - 90) * (Math.PI / 180);
            const barrelOffset = 5;
            
            const startX = gunX + Math.sin(angleRad) * barrelOffset;
            const startY = gunY - Math.cos(angleRad) * barrelOffset;
            
            const bulletDistance = 60;
            const bulletEndX = startX + Math.sin(angleRad) * bulletDistance;
            const bulletEndY = startY - Math.cos(angleRad) * bulletDistance;
            
            trail.style.left = `${startX}%`;
            trail.style.top = `${startY}%`;
            trail.style.transform = `translate(-50%, -50%) rotate(${gunAngle - 90}deg)`;
            
            gameArea.appendChild(trail);
            
            const animationDuration = rapidFireMode ? 200 : 400;
            
            trail.animate([
                { 
                    left: `${startX}%`, 
                    top: `${startY}%`,
                    opacity: 1 
                },
                { 
                    left: `${bulletEndX}%`, 
                    top: `${bulletEndY}%`,
                    opacity: 0 
                }
            ], {
                duration: animationDuration,
                easing: 'ease-out'
            }).onfinish = () => {
                if (trail.parentNode) {
                    trail.remove();
                }
            };
        }

        function checkHits() {
            const gameArea = document.getElementById('gameArea');
            const rect = gameArea.getBoundingClientRect();
            const balloons = document.querySelectorAll('.balloon');
            
            const gunPixelX = rect.left + (rect.width * 0.5);
            const gunPixelY = rect.top + (rect.height * 0.95);
            
            const angleRad = (gunAngle - 90) * (Math.PI / 180);
            const barrelOffset = 35;
            
            const barrelX = gunPixelX + Math.sin(angleRad) * barrelOffset;
            const barrelY = gunPixelY - Math.cos(angleRad) * barrelOffset;
            
            const trajectoryDirX = Math.sin(angleRad);
            const trajectoryDirY = -Math.cos(angleRad);

            let hitDetected = false;

            balloons.forEach(balloon => {
                const balloonRect = balloon.getBoundingClientRect();
                const balloonCenterX = balloonRect.left + balloonRect.width / 2;
                const balloonCenterY = balloonRect.top + balloonRect.height / 2;
                
                const toBalloonX = balloonCenterX - barrelX;
                const toBalloonY = balloonCenterY - barrelY;
                
                const crossProduct = Math.abs(
                    trajectoryDirX * toBalloonY - trajectoryDirY * toBalloonX
                );
                
                const dotProduct = trajectoryDirX * toBalloonX + trajectoryDirY * toBalloonY;
                
                let hitRadius = bigBulletsMode ? 70 : 50;
                if (balloon.classList.contains('balloon-b2') || 
                    balloon.classList.contains('balloon-b3') || 
                    balloon.classList.contains('balloon-b4')) {
                    hitRadius += 10;
                }
                
                if (window.innerWidth <= 768) {
                    hitRadius *= 1.4;
                }
                
                if (crossProduct <= hitRadius && dotProduct > 0) {
                    popBalloon(balloon);
                    showHitMarker(balloonCenterX - rect.left, balloonCenterY - rect.top);
                    hitDetected = true;
                }
            });

            return hitDetected;
        }

        function showHitMarker(x, y) {
            const gameArea = document.getElementById('gameArea');
            const hitMarker = document.createElement('div');
            hitMarker.className = 'hit-marker';
            
            hitMarker.style.left = `${x}px`;
            hitMarker.style.top = `${y}px`;
            hitMarker.style.transform = 'translate(-50%, -50%)';
            
            gameArea.appendChild(hitMarker);
            
            setTimeout(() => {
                if (hitMarker.parentNode) {
                    hitMarker.remove();
                }
            }, 500);
        }

        function showMissIndicator() {
            const gameArea = document.getElementById('gameArea');
            const missIndicator = document.createElement('div');
            missIndicator.className = 'points-popup';
            missIndicator.textContent = 'MISS';
            missIndicator.style.color = '#ff4444';
            missIndicator.style.fontSize = '1.5rem';
            
            const rect = gameArea.getBoundingClientRect();
            const gunX = rect.width * 0.5;
            const gunY = rect.height * 0.95;
            
            const angleRad = (gunAngle - 90) * (Math.PI / 180);
            const missDistance = 150;
            
            const barrelX = gunX + Math.sin(angleRad) * 35;
            const barrelY = gunY - Math.cos(angleRad) * 35;
            
            const missX = barrelX + Math.sin(angleRad) * missDistance;
            const missY = barrelY - Math.cos(angleRad) * missDistance;
            
            missIndicator.style.left = `${missX}px`;
            missIndicator.style.top = `${missY}px`;
            missIndicator.style.transform = 'translate(-50%, -50%)';
            
            gameArea.appendChild(missIndicator);
            
            setTimeout(() => {
                if (missIndicator.parentNode) {
                    missIndicator.remove();
                }
            }, 1500);
        }

        function popBalloon(balloon) {
            // Play sounds
            popSound.currentTime = 0;
            popSound.play().catch(() => {});
            hitSound.currentTime = 0;
            hitSound.play().catch(() => {});
            
            // Get points and type
            const points = parseInt(balloon.dataset.points);
            const balloonType = balloon.dataset.type;
            
            // Handle different balloon types
            if (balloonType === 'bomb') {
                // Bomb balloon - lose points and reset streak
                score = Math.max(0, score + points); // points is negative
                resetStreak();
                showPointsPopup(balloon, points, '#ff4444');
            } else {
                // Normal or golden balloon
                const finalPoints = points * multiplier;
                score += finalPoints;
                
                // Increase streak
                increaseStreak();
                
                showPointsPopup(balloon, finalPoints, balloonType === 'golden' ? '#ffd700' : '#00ff00');
            }
            
            // Check highest score
            if (score > highestScore) {
                highestScore = score;
                saveHighestScore();
                updateHighestScore();
            }
            
            updateScore();
            
            // Enhanced explosion effect
            balloon.src = 'cb.png';
            balloon.style.transform = 'scale(2.5)';
            balloon.style.opacity = '0';
            balloon.style.filter = 'brightness(3) saturate(2)';
            
            // Vibration feedback for hit
            vibrate([100, 50, 100]);
            
            setTimeout(() => {
                if (balloon.parentNode) {
                    balloon.remove();
                }
            }, 400);
        }

        function increaseStreak() {
            streak++;
            updateStreak();
            
            // Update multiplier based on streak
            if (streak >= 10) {
                multiplier = 3;
            } else if (streak >= 5) {
                multiplier = 2;
            } else {
                multiplier = 1;
            }
            updateMultiplier();
            
            // Show combo notifications
            if (streak === 5) {
                showComboNotification('5 Hit Combo!', '#ff6b35');
                comboSound.play().catch(() => {});
            } else if (streak === 10) {
                showComboNotification('10 Hit Combo!', '#ff4444');
                comboSound.play().catch(() => {});
            } else if (streak % 15 === 0) {
                showComboNotification(`${streak} Hit Combo!`, '#9b59b6');
                comboSound.play().catch(() => {});
            }
            
            // Update best streak
            if (streak > bestStreak) {
                bestStreak = streak;
                saveBestStreak();
                updateBestStreak();
            }
        }

        function resetStreak() {
            streak = 0;
            multiplier = 1;
            updateStreak();
            updateMultiplier();
        }

        function updateStreak() {
            const streakDisplay = document.getElementById('streakDisplay');
            const streakCount = document.getElementById('streakCount');
            
            if (streak > 0) {
                streakDisplay.classList.remove('hidden');
                streakCount.textContent = streak;
            } else {
                streakDisplay.classList.add('hidden');
            }
        }

        function updateMultiplier() {
            document.getElementById('multiplier').textContent = multiplier;
        }

                function showComboNotification(text, color) {
            const notification = document.createElement('div');
            notification.className = 'combo-display';
            notification.textContent = text;
            notification.style.color = color;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 1500);
        }

        function showPointsPopup(balloon, points, color) {
            const popup = document.createElement('div');
            popup.className = 'points-popup';
            popup.textContent = points > 0 ? `+${points}` : `${points}`;
            popup.style.color = color;
            
            // Position at balloon location
            const balloonRect = balloon.getBoundingClientRect();
            const gameAreaRect = document.getElementById('gameArea').getBoundingClientRect();
            
            popup.style.left = `${balloonRect.left - gameAreaRect.left + balloonRect.width/2}px`;
            popup.style.top = `${balloonRect.top - gameAreaRect.top}px`;
            popup.style.transform = 'translateX(-50%)';
            
            document.getElementById('gameArea').appendChild(popup);
            
            setTimeout(() => {
                if (popup.parentNode) {
                    popup.remove();
                }
            }, 2000);
        }

        function updateScore() {
            document.getElementById('score').textContent = score;
        }

        function loseLife() {
            lives--;
            updateLives();
            resetStreak();
            
            if (lives <= 0) {
                gameOver();
            }
        }

        function updateLives() {
            const livesContainer = document.getElementById('lives');
            const heartHTML = '<img src="https://www.freeiconspng.com/uploads/heart-icon-14.png" class="w-8 h-8 md:w-10 md:h-10 heart-mobile">';
            livesContainer.innerHTML = Array(lives).fill(heartHTML).join('');
        }

        function gameOver() {
            gameOverSound.play().catch(() => {});
            
            // Clear all intervals
            balloonIntervals.forEach(interval => clearInterval(interval));
            balloonIntervals = [];
            
            // Deactivate power-ups
            deactivatePowerUp();
            
            // Update final scores
            document.getElementById('finalScore').textContent = score;
            updateHighestScore();
            updateBestStreak();
            
            document.getElementById('gameOverScreen').classList.remove('hidden');
        }

        function restartGame() {
            document.getElementById('gameOverScreen').classList.add('hidden');
            startGame();
        }

        // Vibration function for mobile devices
        function vibrate(pattern) {
            if (navigator.vibrate) {
                navigator.vibrate(pattern);
            }
        }

        // Prevent zoom on double tap for mobile
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);

        // Prevent context menu
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
        });

        // Handle orientation change
        window.addEventListener('orientationchange', function() {
            setTimeout(function() {
                updateGunRotation();
            }, 100);
        });

        // Handle window resize
        window.addEventListener('resize', function() {
            updateGunRotation();
        });

        // Auto-hide instructions after 15 seconds
        setTimeout(() => {
            const instructions = document.querySelector('.instructions');
            if (instructions) {
                instructions.style.transition = 'opacity 1s ease';
                instructions.style.opacity = '0';
                setTimeout(() => {
                    instructions.style.display = 'none';
                }, 1000);
            }
        }, 15000);

        // Enhanced mobile touch handling for better gun control
        let touchStartTime = 0;
        let touchStartPos = { x: 0, y: 0 };
        let isDragging = false;

        document.getElementById('gameArea').addEventListener('touchstart', function(e) {
            touchStartTime = Date.now();
            touchStartPos.x = e.touches[0].clientX;
            touchStartPos.y = e.touches[0].clientY;
            isDragging = false;
        });

        document.getElementById('gameArea').addEventListener('touchmove', function(e) {
            e.preventDefault();
            isDragging = true;
            handleTouchMove(e);
        });

        document.getElementById('gameArea').addEventListener('touchend', function(e) {
            const touchEndTime = Date.now();
            const touchDuration = touchEndTime - touchStartTime;
            
            // If it's a quick tap and not dragging, adjust aim to that point
            if (touchDuration < 300 && !isDragging) {
                const rect = this.getBoundingClientRect();
                const touchX = touchStartPos.x;
                const touchY = touchStartPos.y;
                
                const gunX = rect.left + rect.width / 2;
                const gunY = rect.bottom - 50;
                
                const deltaX = touchX - gunX;
                const deltaY = gunY - touchY;
                
                let angle = Math.atan2(deltaX, deltaY) * (180 / Math.PI);
                let gunAngleCalculated = 90 - angle;
                
                if (gunAngleCalculated < 0) gunAngleCalculated += 360;
                if (gunAngleCalculated > 360) gunAngleCalculated -= 360;
                
                if (gunAngleCalculated > 180) {
                    gunAngleCalculated = 360 - gunAngleCalculated;
                }
                
                gunAngleCalculated = Math.max(30, Math.min(180, gunAngleCalculated));
                
                targetAngle = findClosestAngle(gunAngleCalculated);
                snapToAngle();
            }
        });

        // Add sound toggle functionality
        let soundEnabled = true;
        
        function toggleSound() {
            soundEnabled = !soundEnabled;
            const soundBtn = document.getElementById('soundBtn');
            if (soundBtn) {
                soundBtn.textContent = soundEnabled ? 'ðŸ”Š' : 'ðŸ”‡';
                soundBtn.title = soundEnabled ? 'Sound On - Click to Mute' : 'Sound Off - Click to Enable';
            }
        }

        // Override sound playing to respect sound toggle
        const originalAudioPlay = Audio.prototype.play;
        Audio.prototype.play = function() {
            if (soundEnabled) {
                return originalAudioPlay.call(this);
            }
            return Promise.resolve();
        };

        // Add sound toggle button
        function addSoundToggle() {
            const soundBtn = document.createElement('button');
            soundBtn.id = 'soundBtn';
            soundBtn.className = 'fixed top-20 right-20 w-12 h-12 bg-gray-800 text-white rounded-full text-xl z-50 hover:bg-gray-700 transition-colors border-2 border-gray-600';
            soundBtn.textContent = 'ðŸ”Š';
            soundBtn.title = 'Toggle Sound';
            soundBtn.addEventListener('click', toggleSound);
            soundBtn.addEventListener('touchend', function(e) {
                e.preventDefault();
                e.stopPropagation();
                toggleSound();
            });
            
            document.body.appendChild(soundBtn);
        }

        // Initialize sound toggle
        setTimeout(addSoundToggle, 1000);

        // Performance optimization based on device
        function getOptimalSettings() {
            const isMobile = window.innerWidth <= 768;
            const isLowEnd = navigator.hardwareConcurrency && navigator.hardwareConcurrency <= 2;
            
            return {
                balloonInterval: isMobile ? (isLowEnd ? 2500 : 2000) : 1500,
                balloonSpeed: isMobile ? (isLowEnd ? 7000 : 6000) : 5000,
                maxBalloons: isMobile ? (isLowEnd ? 3 : 4) : 6
            };
        }

        // Debug functions
        function debugInfo() {
            console.log('ðŸŽ¯ ENHANCED BALLOON SHOOTER - Debug Info:');
            console.log(`Current Gun Angle: ${gunAngle}Â°`);
            console.log(`Target Angle: ${targetAngle}Â°`);
            console.log(`Score: ${score}, Lives: ${lives}`);
            console.log(`Streak: ${streak}, Multiplier: ${multiplier}x`);
            console.log(`Best Streak: ${bestStreak}`);
            console.log(`Power-up Active: ${powerUpActive} (${powerUpType})`);
            console.log(`Balloons on screen: ${document.querySelectorAll('.balloon').length}`);
            console.log(`Power-ups on screen: ${document.querySelectorAll('.power-up').length}`);
            console.log(`Sound enabled: ${soundEnabled}`);
        }

        // Keyboard shortcuts for debugging and control
        document.addEventListener('keydown', function(e) {
            // Debug info
            if (e.key === 'd' || e.key === 'D') {
                debugInfo();
            }
            
            // Quick angle selection with number keys
            if (e.key >= '1' && e.key <= '9') {
                const index = parseInt(e.key) - 1;
                if (index < presetAngles.length) {
                    targetAngle = presetAngles[index];
                    snapToAngle();
                }
            }
            
            // Reset to center (90Â°) with 'R' key
            if (e.key === 'r' || e.key === 'R') {
                targetAngle = 90;
                snapToAngle();
            }
            
            // Toggle sound with 'S' key
            if (e.key === 's' || e.key === 'S') {
                toggleSound();
            }
        });

        // Initialize game with welcome message
        function showWelcomeMessage() {
            console.log('ðŸŽ¯ ENHANCED BALLOON SHOOTER - Game Loaded!');
            console.log('ðŸš€ NEW FEATURES ADDED:');
            console.log('  âœ… Power-ups: Multi-shot, Rapid Fire, Big Bullets');
            console.log('  âœ… Special Balloons: Golden (+20 pts), Bomb (-10 pts)');
            console.log('  âœ… Moving Balloons: Zigzag pattern (30% chance)');
            console.log('  âœ… Streak System: Build combos for multipliers');
            console.log('  âœ… Multiplier System: 1x â†’ 2x â†’ 3x based on streak');
            console.log('  âœ… Enhanced Visuals: Glowing effects, animations');
            console.log('  âœ… Sound Effects: Power-ups, combos, enhanced audio');
            console.log('  âœ… Mobile Optimized: Better touch controls');
            console.log('ðŸŽ® GAME MECHANICS:');
            console.log('  â€¢ Normal Balloons: 2-10 points');
            console.log('  â€¢ Golden Balloons: 20 points (5% spawn rate)');
            console.log('  â€¢ Bomb Balloons: -10 points (3% spawn rate)');
            console.log('  â€¢ Moving Balloons: Zigzag movement (30% chance)');
            console.log('  â€¢ Power-ups: Spawn every 15 seconds');
            console.log('  â€¢ Streak Multipliers: 5+ hits = 2x, 10+ hits = 3x');
            console.log('  â€¢ Combo Notifications: 5, 10, 15+ hit streaks');
            console.log('ðŸ”« POWER-UPS:');
            console.log('  â€¢ ðŸŸ  Multi-shot (3x): Fires 3 bullets (10s duration)');
            console.log('  â€¢ âš¡ Rapid Fire: Faster shooting (8s duration)');
            console.log('  â€¢ ðŸ’¥ Big Bullets: Larger hit area (12s duration)');
            console.log('ðŸŽ¯ CONTROLS:');
            console.log('  â€¢ Mouse/Touch: Aim gun');
            console.log('  â€¢ Click Gun: Shoot');
            console.log('  â€¢ Click Power-ups: Collect them');
            console.log('  â€¢ Space: Shoot (keyboard)');
            console.log('  â€¢ Arrow Keys: Cycle angles');
            console.log('  â€¢ Number Keys 1-9: Quick angle selection');
            console.log('  â€¢ R: Reset to center');
            console.log('  â€¢ S: Toggle sound');
            console.log('  â€¢ D: Debug info');
        }

        // Show welcome message after game loads
        setTimeout(showWelcomeMessage, 2000);

        // Add performance monitoring
        let frameCount = 0;
        let lastTime = performance.now();
        
        function monitorPerformance() {
            frameCount++;
            const currentTime = performance.now();
            
            if (currentTime - lastTime >= 5000) { // Every 5 seconds
                const fps = Math.round((frameCount * 1000) / (currentTime - lastTime));
                
                if (fps < 30) {
                    console.warn(`âš ï¸ Low FPS detected: ${fps}fps - Consider reducing balloon count`);
                }
                
                frameCount = 0;
                lastTime = currentTime;
            }
            
            requestAnimationFrame(monitorPerformance);
        }

        // Start performance monitoring
        setTimeout(() => {
            requestAnimationFrame(monitorPerformance);
        }, 3000);

        console.log('ðŸŽ¯ ENHANCED BALLOON SHOOTER - Loaded Successfully!');
        console.log('ðŸš€ EXCITING NEW FEATURES:');
        console.log('  ðŸŽ¯ Clean targeting system with crosshair and laser sight');
        console.log('  ðŸŸ¡ Golden balloons worth 20 points');
        console.log('  ðŸ’£ Bomb balloons that reduce score');
        console.log('  ðŸ”„ Moving balloons with zigzag patterns');
        console.log('  âš¡ Power-ups: Multi-shot, Rapid Fire, Big Bullets');
        console.log('  ðŸ”¥ Streak system with score multipliers');
        console.log('  ðŸŽŠ Combo notifications and effects');
        console.log('  ðŸ“± Enhanced mobile controls');
        console.log('  ðŸ”Š Rich sound effects and audio feedback');
        console.log('  âœ¨ Smooth animations and visual effects');
        console.log('ðŸŽ® ENHANCED BALLOON SHOOTER IS READY TO PLAY!');
    </script>
</body>
</html>



